---
- name: Install Jenkins OIDC Plugin
  hosts: jenkins
  gather_facts: true
  become: false

  pre_tasks:
    - name: Display plugin installation information
      debug:
        msg: |
          ğŸ”Œ Jenkins OIDC Plugin Installation
          ğŸ“… Execution time: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  Jenkins server: {{ inventory_hostname }}
          ğŸ“¦ Target plugin: OpenID Connect Authentication (oic-auth)
          ğŸ‘¤ User: {{ ansible_user }}

    - name: Verify Jenkins server accessibility
      uri:
        url: "http://{{ inventory_hostname }}:8080/"
        method: GET
        timeout: 30
        status_code: [200, 403]
      register: jenkins_health
      retries: 3
      delay: 5

    - name: Display Jenkins status
      debug:
        msg: |
          ğŸ“Š Jenkins Status Check:
          âœ… Server: {{ inventory_hostname }}:8080
          âœ… Status: {{ 'Online' if jenkins_health.status in [200, 403] else 'Offline' }}
          âœ… Ready for plugin installation

  roles:
    - role: jenkins-oidc-plugin
      vars:
        jenkins_oidc_plugin_id: "oic-auth"
        jenkins_oidc_plugin_version: "latest"

  post_tasks:
    - name: Verify plugin installation completion
      uri:
        url: "http://{{ inventory_hostname }}:8080/pluginManager/api/json?tree=plugins[shortName,version,enabled]"
        method: GET
        timeout: 30
      register: final_plugin_check
      retries: 3
      delay: 5
      ignore_errors: yes

    - name: Check if OIDC plugin is now available
      set_fact:
        oidc_plugin_available: "{{ (final_plugin_check.json.plugins | selectattr('shortName', 'equalto', 'oic-auth') | list | length > 0) if final_plugin_check.status == 200 else false }}"

    - name: Display installation completion
      debug:
        msg: |
          âœ… Jenkins OIDC Plugin Installation Complete!

          ğŸ“¦ Installation Summary:
          â€¢ Plugin: OpenID Connect Authentication (oic-auth)
          â€¢ Status: {{ 'Successfully Installed' if oidc_plugin_available else 'Check Required' }}
          â€¢ Jenkins: {{ inventory_hostname }}:8080

          ğŸ”§ Next Steps:
          {% if oidc_plugin_available %}
          1. âœ… Plugin is ready for configuration
          2. ğŸ”§ Configure Jenkins Security Settings:
             - Go to Manage Jenkins > Security
             - Set Security Realm to "OpenID Connect"
             - Configure with Keycloak settings
          3. ğŸ§ª Test SSO login functionality
          {% else %}
          1. âš ï¸  Manual verification may be required
          2. ğŸ” Check Jenkins plugin manager for OIDC plugin
          3. ğŸ”„ Restart Jenkins if necessary
          {% endif %}

          ğŸ“š Configuration Details:
          â€¢ Keycloak Realm: jenkins
          â€¢ Client ID: jenkins
          â€¢ Well-known URL: http://192.168.201.12:8080/realms/jenkins/.well-known/openid_configuration
