---
- name: Setup dedicated FreeIPA nginx vhost and exclude it from dynamic config
  hosts: nginx
  gather_facts: yes
  become: yes

  vars:
    freeipa_server_name: "freeipa.local"
    freeipa_backend_host: "192.168.201.13"
    freeipa_backend_port: "80"
    nginx_exclude_server_names:
      - "freeipa.local"

    # Defaults mirrored from roles
    nginx_listen_port: 80
    nginx_access_log: /var/log/nginx/access.log
    nginx_error_log: /var/log/nginx/error.log
    nginx_keepalive_connections: 32
    nginx_client_max_body_size: 10m
    nginx_client_body_buffer_size: 128k
    nginx_proxy_connect_timeout: 90
    nginx_proxy_send_timeout: 90
    nginx_proxy_read_timeout: 90

    nginx_http_port: 80
    nginx_https_port: 443

    ssl_cert_dir: /etc/nginx/tls
    ssl_dhparam_file: "{{ ssl_cert_dir }}/dhparam.pem"
    ssl_protocols: "TLSv1.2 TLSv1.3"
    ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    ssl_prefer_server_ciphers: "off"

  pre_tasks:
    - name: Display plan
      ansible.builtin.debug:
        msg: |
          Deploying dedicated vhost for {{ freeipa_server_name }} and excluding it from dynamic config.
          Backend: {{ freeipa_backend_host }}:{{ freeipa_backend_port }} on host {{ inventory_hostname }}

  tasks:
    - name: Deploy FreeIPA HTTP vhost (freeipa.conf)
      ansible.builtin.template:
        src: ../roles/setup-nginx-reverse-proxy/templates/freeipa.conf.j2
        dest: "{{ nginx_config_path | default('/etc/nginx/conf.d') }}/freeipa.conf"
        owner: root
        group: root
        mode: '0644'
      vars:
        nginx_server_name: "{{ freeipa_server_name }}"
        backend_host: "{{ freeipa_backend_host }}"
        backend_port: "{{ freeipa_backend_port }}"

    - name: Deploy FreeIPA HTTPS vhost (freeipa-ssl.conf)
      ansible.builtin.template:
        src: ../roles/setup-nginx-reverse-proxy/templates/freeipa-ssl.conf.j2
        dest: "{{ nginx_config_path | default('/etc/nginx/conf.d') }}/freeipa-ssl.conf"
        owner: root
        group: root
        mode: '0644'
      vars:
        nginx_server_name: "{{ freeipa_server_name }}"
        backend_host: "{{ freeipa_backend_host }}"
        backend_port: "{{ freeipa_backend_port }}"

    - name: Re-apply nginx reverse proxy role excluding FreeIPA
      include_role:
        name: setup-nginx-reverse-proxy

    - name: Test nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted

  post_tasks:
    - name: Display vhost deployment summary
      ansible.builtin.debug:
        msg: |
          âœ… Dedicated FreeIPA vhost deployed.
          Excluded {{ freeipa_server_name }} from dynamic configs.
          Test with: curl -Ik --resolve {{ freeipa_server_name }}:443:{{ inventory_hostname }} https://{{ freeipa_server_name }}/
