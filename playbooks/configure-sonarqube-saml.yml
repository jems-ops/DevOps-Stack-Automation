---
# Playbook: Configure SonarQube SAML Integration with Keycloak
# This playbook sets up SAML SSO between SonarQube and Keycloak
# using the generic keycloak-saml-integration role

- name: Configure SonarQube SAML Integration with Keycloak
  hosts: sonarqube_servers
  become: yes

  vars:
    # Application Type Configuration
    keycloak_saml_app_type: "sonarqube"

    # SonarQube-specific Configuration
    sonarqube_hostname: "sonar.local"
    sonarqube_base_url: "https://{{ sonarqube_hostname }}"

    # Keycloak Configuration
    keycloak_hostname: "keycloak.local"
    keycloak_base_url: "https://{{ keycloak_hostname }}"

    # HTTPS Configuration
    keycloak_saml_use_https: true

  pre_tasks:
    - name: Verify SonarQube is running
      ansible.builtin.systemd:
        name: sonarqube
        state: started
      register: sonarqube_service

    - name: Verify Keycloak is accessible
      ansible.builtin.uri:
        url: "{{ keycloak_base_url }}/realms/master"
        method: GET
        validate_certs: no
        status_code: 200
      register: keycloak_health
      failed_when: false
      check_mode: no

    - name: Display pre-flight check results
      ansible.builtin.debug:
        msg:
          - "‚úÖ SonarQube service status: {{ sonarqube_service.status.ActiveState | default('unknown') }}"
          - "‚úÖ Keycloak accessible: {{ keycloak_health.status | default(0) == 200 }}"

  roles:
    - role: keycloak-saml-integration
      tags:
        - sonarqube
        - saml
        - keycloak

  post_tasks:
    - name: Display SAML login instructions
      ansible.builtin.debug:
        msg:
          - "üéâ SonarQube SAML Integration Complete!"
          - ""
          - "üìã Test User Credentials:"
          - "   Username: sonarqube-demo"
          - "   Password: SonarqubeDemo123!"
          - "   Groups: sonarqube-users, sonarqube-admins"
          - ""
          - "üîê SAML Login:"
          - "   {{ sonarqube_base_url }}"
          - "   Look for 'Log in with SAML' button on the login page"
          - ""
          - "üí° Note: SonarQube automatically displays a SAML login button when SAML is enabled."
          - ""
          - "üîß First-time Setup:"
          - "   1. Login with SAML using the test user"
          - "   2. Grant admin permissions to sonarqube-admins group in SonarQube UI"
          - "   3. Configure group synchronization if needed"
