---
- name: Configure Jenkins-Keycloak SAML Integration
  hosts: jenkins
  become: yes
  vars:
    # Keycloak Configuration Variables (override role defaults)
    keycloak_protocol: "http"
    keycloak_host: "192.168.201.12"  # Keycloak server from inventory
    keycloak_port: 8080

    keycloak:
      protocol: "{{ keycloak_protocol }}"
      host: "{{ keycloak_host }}"
      port: "{{ keycloak_port }}"
      base_url: "{{ keycloak_protocol }}://{{ keycloak_host }}:{{ keycloak_port }}"
      realm: "jenkins"
      admin_user: "admin"
      admin_password: "{{ vault_keycloak_admin_password | default('admin123') }}"

      saml_client:
        client_id: "jenkins-saml"
        protocol: "saml"
        enabled: true
        front_channel_logout: true
        redirect_uris:
          - "{{ jenkins.base_url }}/securityRealm/finishLogin"
          - "{{ jenkins.base_url }}/securityRealm/finishLogin/*"
        web_origins:
          - "{{ jenkins.base_url }}"
        base_url: "{{ jenkins.base_url }}"
        root_url: "{{ jenkins.base_url }}"
        admin_url: "{{ jenkins.base_url }}"
        attributes:
          saml_authnstatement: "true"
          saml_server_signature: "true"
          saml_signature_algorithm: "RSA_SHA256"
          saml_client_signature: "false"
          saml_assertion_signature: "true"
          saml_encrypt: "false"
          saml_force_post_binding: "true"
          saml_name_id_format: "username"
          saml_signing_certificate: ""
          saml_signing_private_key: ""
        protocol_mappers:
          - name: "username"
            protocol: "saml"
            protocol_mapper: "saml-user-property-mapper"
            config:
              attribute_name: "username"
              attribute_nameformat: "urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
              user_attribute: "username"
          - name: "email"
            protocol: "saml"
            protocol_mapper: "saml-user-property-mapper"
            config:
              attribute_name: "email"
              attribute_nameformat: "urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
              user_attribute: "email"
          - name: "displayName"
            protocol: "saml"
            protocol_mapper: "saml-user-property-mapper"
            config:
              attribute_name: "displayName"
              attribute_nameformat: "urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
              user_attribute: "username"
          - name: "groups"
            protocol: "saml"
            protocol_mapper: "saml-group-membership-mapper"
            config:
              attribute_name: "groups"
              attribute_nameformat: "urn:oasis:names:tc:SAML:2.0:attrname-format:basic"
              single: "false"
              full_path: "false"

    # Jenkins Configuration
    jenkins:
      base_url: "http://192.168.201.14:8080"  # Jenkins server from inventory
      home: "/var/lib/jenkins"
      config_file: "config.xml"
      user: "jenkins"
      group: "jenkins"
      saml:
        display_name: "Keycloak SAML SSO"
        sp_entity_id: "jenkins-saml"
        username_attribute: "username"
        email_attribute: "email"
        full_name_attribute: "displayName"
        groups_attribute: "groups"
        force_authentication: false
        maximum_authentication_lifetime: 7776000  # 90 days

    # Groups Configuration
    groups:
      jenkins_admins:
        name: "jenkins-admins"
        description: "Jenkins Administrators with full access"
      jenkins_users:
        name: "jenkins-users"
        description: "Jenkins Users with basic access"

    # Test User Configuration (optional - enable for testing)
    test_user:
      enabled: true  # Set to false to disable test user creation
      username: "jenkins-demo"
      email: "jenkins-demo@example.com"
      first_name: "Jenkins"
      last_name: "Demo"
      password: "JenkinsDemo123!"
      groups:
        - "jenkins-users"

    # Debug Configuration
    debug:
      enabled: true
      log_level: "info"

  pre_tasks:
    - name: Display integration setup information
      ansible.builtin.debug:
        msg:
          - "ğŸ” Jenkins-Keycloak SAML Integration Setup"
          - "ğŸ—ï¸  Jenkins Server: {{ jenkins.base_url }}"
          - "ğŸ”‘ Keycloak Server: {{ keycloak.protocol }}://{{ keycloak.host }}:{{ keycloak.port }}"
          - "ğŸ›ï¸  Target Realm: {{ keycloak.realm }}"
          - "ğŸ‘¤ SAML Client: {{ keycloak.saml_client.client_id }}"
          - ""
          - "ğŸ“‹ Prerequisites Check:"
          - "  âœ“ Jenkins SAML plugin must be installed"
          - "  âœ“ Keycloak server must be running and accessible"
          - "  âœ“ Target realm must exist in Keycloak"
          - ""

    - name: Check Jenkins SAML plugin installation
      ansible.builtin.stat:
        path: "/var/lib/jenkins/plugins/saml.hpi"
      register: jenkins_saml_plugin
      become: yes

    - name: Verify SAML plugin is installed
      ansible.builtin.assert:
        that:
          - jenkins_saml_plugin.stat.exists
        fail_msg: |
          Jenkins SAML plugin is not installed. Please install it first:
          1. Download the SAML plugin (.hpi file)
          2. Copy to /var/lib/jenkins/plugins/
          3. Restart Jenkins
        success_msg: "Jenkins SAML plugin is installed"

  roles:
    - jenkins-keycloak-saml

  post_tasks:
    - name: Display completion summary
      ansible.builtin.debug:
        msg:
          - "ğŸ‰ Jenkins-Keycloak SAML integration completed successfully!"
          - ""
          - "ğŸŒ Access Information:"
          - "  Jenkins: {{ jenkins.base_url }}"
          - "  Keycloak Admin: {{ keycloak.protocol }}://{{ keycloak.host }}:{{ keycloak.port }}/admin/"
          - ""
          - "ğŸ” Testing Instructions:"
          - "  1. Open {{ jenkins.base_url }}/login"
          - "  2. Look for 'Log in via SAML' or similar button"
          - "  3. Click it to test SAML authentication"
          - "{% if test_user.enabled %}"
          - "  4. Test with demo user: {{ test_user.username }} / {{ test_user.password }}"
          - "{% endif %}"
          - ""
          - "ğŸ‘¥ Group Management:"
          - "  - Add users to '{{ groups.jenkins_admins.name }}' for admin access"
          - "  - Add users to '{{ groups.jenkins_users.name }}' for basic access"
          - ""
          - "âš™ï¸  Next Steps:"
          - "  1. Configure Jenkins authorization strategy to use SAML groups"
          - "  2. Test user login and verify group mappings"
          - "  3. Add more users/groups in Keycloak as needed"
          - "  4. Configure Jenkins project permissions based on groups"
