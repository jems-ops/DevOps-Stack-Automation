---
- name: Install SSL Certificates for Dynamic Nginx Reverse Proxy
  hosts: nginx
  gather_facts: yes
  become: yes
  
  pre_tasks:
    - name: Display dynamic SSL installation information
      debug:
        msg: |
          ğŸ”’ Dynamic SSL Certificate Installation Playbook
          ğŸ“… Execution time: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  Nginx server: {{ inventory_hostname }}
          ğŸ  Certificate directory: /etc/nginx/tls
          ğŸŒ Backends: {{ site_backends | map(attribute='server_name') | join(', ') }}
          ğŸ“‹ Certificates to generate: {{ site_backends | length }}
          ğŸ‘¤ User: {{ ansible_user }}
          
  roles:
    - install-ssl-cert
    
  post_tasks:
    - name: Display dynamic SSL completion message
      debug:
        msg: |
          âœ… Dynamic SSL Certificate Installation Complete!
          
          ğŸ“Š Summary:
          â€¢ SSL enabled on: {{ inventory_hostname }}
          â€¢ Backends configured: {{ site_backends | length }}
          {% for backend in site_backends %}
          â€¢ {{ backend.server_name }}: /etc/nginx/tls/{{ backend.server_name }}.crt
          {% endfor %}
          
          ğŸ”’ Security Features:
          â€¢ Self-signed SSL certificates
          â€¢ TLS 1.2 and 1.3 support
          â€¢ Strong cipher suites
          â€¢ HSTS enabled
          â€¢ HTTP â†’ HTTPS redirect
          â€¢ Per-backend certificates
          
          ğŸŒ Access Information (HTTPS):
          {% for backend in site_backends %}
          â€¢ https://{{ backend.server_name }} â†’ {{ backend.ip }}:{{ backend.port }}
          {% endfor %}
          
          âš ï¸  Note: Self-signed certificates require browser security exceptions
          
          ğŸ‰ All backends are now accessible via HTTPS reverse proxy!
