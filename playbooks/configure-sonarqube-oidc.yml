---
- name: Configure SonarQube OIDC Settings
  hosts: sonarqube
  become: true
  vars:
    sonarqube_client_secret: "sonarqube-sso-secret-2024-secure"
    keycloak_server: "{{ groups['keycloak'][0] }}"
    sonarqube_realm: sonar
  tasks:
    - name: Display SonarQube OIDC configuration
      debug:
        msg: |
          üîß Configuring SonarQube OIDC Settings
          üèõÔ∏è  Keycloak Server: {{ keycloak_server }}:8080
          üë§ Client ID: sonarqube
          üåê Realm: {{ sonarqube_realm }}

    - name: Check current SonarQube status
      systemd:
        name: sonarqube
      register: sonarqube_status

    - name: Stop SonarQube service
      systemd:
        name: sonarqube
        state: stopped
      when: sonarqube_status.status.ActiveState == "active"

    - name: Backup current sonar.properties
      copy:
        src: /opt/sonarqube/conf/sonar.properties
        dest: "/opt/sonarqube/conf/sonar.properties.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes

    - name: Configure SonarQube OIDC authentication
      blockinfile:
        path: /opt/sonarqube/conf/sonar.properties
        marker: "# {mark} ANSIBLE MANAGED OIDC CONFIGURATION"
        block: |
          # OpenID Connect (OIDC) Configuration for Keycloak
          sonar.auth.oidc.enabled=true
          sonar.auth.oidc.issuerUri=http://{{ keycloak_server }}:8080/realms/{{ sonarqube_realm }}
          sonar.auth.oidc.clientId.secured=sonarqube
          sonar.auth.oidc.clientSecret.secured={{ sonarqube_client_secret }}
          sonar.auth.oidc.loginButtonText=Login with Keycloak
          sonar.auth.oidc.scopes=openid email profile

          # User attributes mapping
          sonar.auth.oidc.emailAttribute=email
          sonar.auth.oidc.nameAttribute=name
          sonar.auth.oidc.loginAttribute=preferred_username

          # Group synchronization
          sonar.auth.oidc.groupsSync=true
          sonar.auth.oidc.groupsSync.claimName=groups

          # Allow users to sign-up
          sonar.auth.oidc.allowUsersToSignUp=true
        backup: yes

    - name: Start SonarQube service
      systemd:
        name: sonarqube
        state: started
        enabled: yes

    - name: Wait for SonarQube to be ready
      uri:
        url: "http://localhost:9000/"
        method: GET
        timeout: 30
      register: sonarqube_ready
      retries: 20
      delay: 15
      until: sonarqube_ready.status == 200

    - name: Display completion message
      debug:
        msg: |
          ‚úÖ SonarQube OIDC Configuration Complete!

          üìã Configuration Applied:
          ‚Ä¢ OIDC Enabled: ‚úÖ
          ‚Ä¢ Keycloak Issuer: http://{{ keycloak_server }}:8080/realms/{{ sonarqube_realm }}
          ‚Ä¢ Client ID: sonarqube
          ‚Ä¢ Login Button: "Login with Keycloak"
          ‚Ä¢ Group Sync: Enabled

          üåê Access SonarQube:
          ‚Ä¢ Direct: http://localhost:9000
          ‚Ä¢ External: http://{{ inventory_hostname }}:9000

          üîß Next Steps:
          1. Access SonarQube web interface
          2. Look for "Login with Keycloak" button
          3. Test authentication with existing users (jenkins-admin/admin123)
          4. Verify user provisioning and group mapping
