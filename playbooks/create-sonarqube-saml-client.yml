---
- name: Create SonarQube SAML Client in Keycloak
  hosts: localhost
  connection: local
  vars:
    keycloak_server: "{{ groups['keycloak'][0] }}"
    sonar_realm: sonar
    saml_client_id: sonarqube-saml
  tasks:
    - name: Display SAML client creation information
      debug:
        msg: |
          üîß Creating SonarQube SAML Client in Keycloak
          üèõÔ∏è  Keycloak Server: {{ keycloak_server }}:8080
          üåê Realm: {{ sonar_realm }}
          üë§ SAML Client ID: {{ saml_client_id }}
          üì° SonarQube Server: {{ groups['sonarqube'][0] }}:9000

    - name: Create SonarQube SAML client in Keycloak
      community.general.keycloak_client:
        auth_keycloak_url: "http://{{ keycloak_server }}:8080"
        auth_realm: master
        auth_username: admin
        auth_password: admin123
        realm: "{{ sonar_realm }}"
        client_id: "{{ saml_client_id }}"
        protocol: saml
        enabled: true
        name: "SonarQube SAML Client"
        description: "SAML client for SonarQube authentication"
        base_url: "http://{{ groups['sonarqube'][0] }}:9000"
        redirect_uris:
          - "http://{{ groups['sonarqube'][0] }}:9000/oauth2/callback/saml"
          - "http://{{ groups['sonarqube'][0] }}:9000/sessions/*"
        attributes:
          saml_assertion_signature: "true"
          saml.assertion.signature: "true"
          saml.server.signature: "true"
          saml.client.signature: "false"
          saml_signature_algorithm: "RSA_SHA256"
          saml_name_id_format: "username"
          saml_encrypt: "false"
          saml_authnstatement: "true"
          saml_onetimeuse_condition: "false"
          saml_force_name_id_format: "false"
        protocol_mappers:
          - name: "email"
            protocol: "saml"
            protocolMapper: "saml-user-property-mapper"
            config:
              attribute.nameformat: "Basic"
              user.attribute: "email"
              attribute.name: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
          - name: "name"
            protocol: "saml"
            protocolMapper: "saml-user-property-mapper"
            config:
              attribute.nameformat: "Basic"
              user.attribute: "firstName lastName"
              attribute.name: "http://schemas.microsoft.com/ws/2008/06/identity/claims/name"
          - name: "username"
            protocol: "saml"
            protocolMapper: "saml-user-property-mapper"
            config:
              attribute.nameformat: "Basic"
              user.attribute: "username"
              attribute.name: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
          - name: "groups"
            protocol: "saml"
            protocolMapper: "saml-group-membership-mapper"
            config:
              attribute.nameformat: "Basic"
              attribute.name: "groups"
              full.path: "false"
        state: present

    - name: Display completion message
      debug:
        msg: |
          ‚úÖ SonarQube SAML Client Created Successfully!

          üìã Client Configuration:
          ‚Ä¢ Protocol: SAML
          ‚Ä¢ Client ID: {{ saml_client_id }}
          ‚Ä¢ Base URL: http://{{ groups['sonarqube'][0] }}:9000
          ‚Ä¢ Callback URL: http://{{ groups['sonarqube'][0] }}:9000/oauth2/callback/saml

          üè∑Ô∏è  Mapped Attributes:
          ‚Ä¢ Email ‚Üí http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress
          ‚Ä¢ Name ‚Üí http://schemas.microsoft.com/ws/2008/06/identity/claims/name
          ‚Ä¢ Username ‚Üí http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name
          ‚Ä¢ Groups ‚Üí groups

          üîß Next Steps:
          1. Configure SonarQube SAML settings
          2. Test SAML authentication flow
