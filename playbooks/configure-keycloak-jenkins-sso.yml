---
- name: Configure Keycloak for Jenkins SSO using Red Hat Middleware Collection
  hosts: keycloak
  vars:
    keycloak_admin_password: "{{ vault_KEYCLOAK_ADMIN_PASSWORD }}"
    jenkins_sso_realm: jenkins
    keycloak_jenkins_client_id: jenkins
    # Jenkins URLs for redirect configuration
    jenkins_base_url: "http://192.168.201.14:8080"
    jenkins_proxy_url: "https://jenkins.example.com"
  collections:
    - middleware_automation.keycloak
  tasks:
    - name: Configure Jenkins SSO Realm
      ansible.builtin.include_role:
        name: keycloak_realm
      vars:
        keycloak_client_default_roles:
          - jenkins-admins
          - jenkins-users
        keycloak_client_users:
          - username: jenkins-admin
            password: admin123
            email: admin@jenkins.local
            first_name: Jenkins
            last_name: Administrator
            client_roles:
              - client: "{{ keycloak_jenkins_client_id }}"
                role: jenkins-admins
                realm: "{{ jenkins_sso_realm }}"
              - client: "{{ keycloak_jenkins_client_id }}"
                role: jenkins-users
                realm: "{{ jenkins_sso_realm }}"
          - username: jenkins-user
            password: user123
            email: user@jenkins.local
            first_name: Jenkins
            last_name: User
            client_roles:
              - client: "{{ keycloak_jenkins_client_id }}"
                role: jenkins-users
                realm: "{{ jenkins_sso_realm }}"
        keycloak_realm: "{{ jenkins_sso_realm }}"
        keycloak_host: http://localhost:8080
        keycloak_admin_user: admin
        keycloak_admin_password: "{{ vault_KEYCLOAK_ADMIN_PASSWORD }}"
        keycloak_clients:
          - name: "{{ keycloak_jenkins_client_id }}"
            client_id: "{{ keycloak_jenkins_client_id }}"
            roles: "{{ keycloak_client_default_roles }}"
            realm: "{{ jenkins_sso_realm }}"
            public_client: false
            protocol: openid-connect
            client_authenticator_type: client-secret
            secret: "{{ vault_jenkins_oidc_client_secret }}"
            standard_flow_enabled: true
            implicit_flow_enabled: false
            direct_access_grants_enabled: true
            service_accounts_enabled: false
            full_scope_allowed: true
            web_origins:
              - "{{ jenkins_base_url }}"
              - "{{ jenkins_proxy_url }}"
              - "+"
            redirect_uris:
              - "{{ jenkins_base_url }}/securityRealm/finishLogin"
              - "{{ jenkins_proxy_url }}/securityRealm/finishLogin"
              - "{{ jenkins_base_url }}/*"
              - "{{ jenkins_proxy_url }}/*"
            users: "{{ keycloak_client_users }}"

    - name: Verify Keycloak realm configuration
      uri:
        url: "http://localhost:8080/realms/{{ jenkins_sso_realm }}/.well-known/openid_configuration"
        method: GET
        timeout: 30
      register: oidc_config_check
      retries: 3
      delay: 5

    - name: Display OIDC configuration validation
      debug:
        msg: |
          âœ… Jenkins Keycloak SSO Configuration Complete!

          ğŸ“‹ Configuration Summary:
          ğŸ›ï¸  Keycloak Realm: {{ jenkins_sso_realm }}
          ğŸ‘¤ Client ID: {{ keycloak_jenkins_client_id }}
          ğŸ”— OIDC Well-known URL: http://localhost:8080/realms/{{ jenkins_sso_realm }}/.well-known/openid_configuration
          ğŸŒ Jenkins URLs:
            â€¢ Direct: {{ jenkins_base_url }}
            â€¢ Proxy: {{ jenkins_proxy_url }}

          ğŸ‘¥ Test Users:
          â€¢ jenkins-admin (jenkins-admins, jenkins-users)
          â€¢ jenkins-user (jenkins-users)
