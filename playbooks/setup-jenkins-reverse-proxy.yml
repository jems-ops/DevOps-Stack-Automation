---
- name: Setup Nginx Reverse Proxy for Jenkins Only
  hosts: nginx
  gather_facts: yes
  become: yes

  vars:
    # Override site_backends to include only Jenkins
    site_backends:
      - server_name: "jenkins.example.com"
        ip: "192.168.201.14"
        port: "8080"
        # Jenkins-specific rewrite rule (optional)
        rewrite_rule: "^/jenkins/(.*) /$1 break"

  pre_tasks:
    - name: Display Jenkins-specific proxy setup information
      debug:
        msg: |
          ğŸŒ Jenkins-Specific Nginx Reverse Proxy Setup
          ğŸ“… Execution time: {{ ansible_date_time.iso8601 }}
          ğŸ–¥ï¸  Nginx server: {{ inventory_hostname }}
          ğŸ”— Jenkins backend: {{ site_backends[0].ip }}:{{ site_backends[0].port }}
          ğŸ·ï¸  Domain: {{ site_backends[0].server_name }}
          ğŸ‘¤ User: {{ ansible_user }}

  roles:
    - setup-nginx-reverse-proxy

  post_tasks:
    - name: Display Jenkins reverse proxy completion message
      debug:
        msg: |
          âœ… Jenkins Nginx Reverse Proxy Setup Complete!

          ğŸ“Š Summary:
          â€¢ Nginx server: {{ inventory_hostname }}
          â€¢ Jenkins backend: {{ site_backends[0].ip }}:{{ site_backends[0].port }}
          â€¢ Configuration: /etc/nginx/conf.d/dynamic-backends.conf
          â€¢ Domain: {{ site_backends[0].server_name }}

          ğŸŒ Access Information:
          â€¢ Direct Jenkins: http://{{ site_backends[0].ip }}:{{ site_backends[0].port }}
          â€¢ Via HTTPS Proxy: https://{{ site_backends[0].server_name }}
          â€¢ Via HTTP Proxy: http://{{ site_backends[0].server_name }} (redirects to HTTPS)

          ğŸ”’ Security Features:
          â€¢ SSL/TLS enabled
          â€¢ HTTP to HTTPS redirect
          â€¢ HSTS headers
          â€¢ Security headers configured

          ğŸ”§ Next Steps:
          1. Test proxy: curl -I https://{{ site_backends[0].server_name }}
          2. Configure DNS/hosts: {{ site_backends[0].server_name }} â†’ {{ inventory_hostname }}
          3. Access Jenkins: https://{{ site_backends[0].server_name }}

          ğŸ‰ Jenkins is now accessible via HTTPS reverse proxy!
