---
- name: Display SSL certificate installation information
  debug:
    msg: "Installing SSL certificates for: {{ site_backends | map(attribute='server_name') | join(', ') }}"

- name: Install OpenSSL
  dnf:
    name: openssl
    state: present

- name: Create SSL certificate directory
  file:
    path: "{{ ssl_cert_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if SSL certificates exist for each backend
  stat:
    path: "{{ ssl_cert_dir }}/{{ item.server_name }}.crt"
  register: ssl_cert_exists
  loop: "{{ site_backends }}"
  loop_control:
    label: "{{ item.server_name }}"

- name: Generate SSL private keys for each backend
  openssl_privatekey:
    path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.key"
    size: 2048
    type: RSA
    owner: root
    group: root
    mode: '0600'
  when: not item.stat.exists
  loop: "{{ ssl_cert_exists.results }}"
  loop_control:
    label: "{{ item.item.server_name }}"

- name: Generate SSL certificate signing requests for each backend
  openssl_csr:
    path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.csr"
    privatekey_path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.key"
    common_name: "{{ item.item.server_name }}"
    country_name: "{{ ssl_country }}"
    state_or_province_name: "{{ ssl_state }}"
    locality_name: "{{ ssl_city }}"
    organization_name: "{{ ssl_organization }}"
    organizational_unit_name: "{{ ssl_organization_unit }}"
    email_address: "{{ ssl_email }}"
    subject_alt_name: "{{ ['DNS:' ~ item.item.server_name, 'DNS:' ~ ansible_hostname, 'IP:' ~ ansible_default_ipv4.address] + (item.item.extra_sans | default([]) | map('regex_replace', '^(.*)$', 'DNS:\\1') | list) }}"
  when: not item.stat.exists
  loop: "{{ ssl_cert_exists.results }}"
  loop_control:
    label: "{{ item.item.server_name }}"

- name: Generate self-signed SSL certificates for each backend
  openssl_certificate:
    path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.crt"
    privatekey_path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.key"
    csr_path: "{{ ssl_cert_dir }}/{{ item.item.server_name }}.csr"
    provider: selfsigned
    selfsigned_not_after: "+{{ ssl_cert_days }}d"
    owner: root
    group: root
    mode: '0644'
  when: not item.stat.exists
  loop: "{{ ssl_cert_exists.results }}"
  loop_control:
    label: "{{ item.item.server_name }}"

- name: Check if DH parameters exist
  stat:
    path: "{{ ssl_dhparam_file }}"
  register: ssl_dhparam_exists

- name: Generate Diffie-Hellman parameters
  openssl_dhparam:
    path: "{{ ssl_dhparam_file }}"
    size: "{{ ssl_dhparam_bits }}"
    owner: root
    group: root
    mode: '0644'
  when: not ssl_dhparam_exists.stat.exists

- name: Backup existing nginx configuration
  copy:
    src: "{{ nginx_config_path }}/{{ nginx_config_file }}"
    dest: "{{ nginx_config_path }}/{{ nginx_config_file }}.backup-{{ ansible_date_time.epoch }}"
    remote_src: yes
  ignore_errors: yes

- name: Deploy SSL-enabled dynamic nginx configuration
  template:
    src: dynamic-backends-ssl.conf.j2
    dest: "{{ nginx_config_path }}/{{ nginx_config_file }}"
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify:
    - test nginx config
    - restart nginx

- name: Test nginx configuration with SSL
  command: nginx -t
  register: nginx_ssl_config_test
  changed_when: false

- name: Restart nginx to load SSL configuration
  systemd:
    name: nginx
    state: restarted

- name: Wait for nginx to start with SSL
  wait_for:
    port: "{{ nginx_https_port }}"
    host: "{{ inventory_hostname }}"
    delay: 5
    timeout: 60

- name: Test HTTPS connections for each backend
  uri:
    url: "https://{{ inventory_hostname }}"
    method: GET
    headers:
      Host: "{{ item.server_name }}"
    validate_certs: no
    timeout: 10
  register: https_tests
  loop: "{{ site_backends }}"
  loop_control:
    label: "{{ item.server_name }}"
  ignore_errors: yes

- name: Display SSL certificate completion
  debug:
    msg: |
      SSL certificates installed successfully
      Certificates: {{ site_backends | length }}
      Directory: {{ ssl_cert_dir }}
      Validity: {{ ssl_cert_days }} days
      Note: Self-signed certificates require browser security exceptions
