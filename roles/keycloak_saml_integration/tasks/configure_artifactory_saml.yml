---
# Configure Artifactory SAML Authentication via REST API

- name: Compute SAML URLs and attributes
  ansible.builtin.set_fact:
    saml_login_url: "{{ keycloak_saml_integration_keycloak.admin_api_url }}/realms/{{ keycloak_saml_integration_keycloak.realm }}/protocol/saml"
    saml_sp_name: "{{ keycloak_saml_integration_artifactory_saml.service_provider_name | default('artifactory') }}"
    saml_email_attribute: "{{ keycloak_saml_integration_app_saml.email_attribute | default('email') }}"
    saml_group_attribute: "{{ keycloak_saml_integration_app_saml.groups_attribute | default('groups') }}"

- name: Apply SAML configuration via Artifactory API
  ansible.builtin.uri:
    url: "{{ artifactory_api_url | default(artifactory_base_url) }}/artifactory/api/saml/config"
    method: PUT
    user: "{{ artifactory_admin_user | default('admin') }}"
    password: "{{ artifactory_admin_password | default('Artifactory@2025') }}"
    force_basic_auth: yes
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      enableIntegration: true
      loginUrl: "{{ saml_login_url }}"
      logoutUrl: "{{ saml_login_url }}"
      serviceProviderName: "{{ saml_sp_name }}"
      certificate: "{{ keycloak_saml_integration_certificate }}"
      useEncryptedAssertion: false
      syncGroups: true
      groupAttribute: "{{ saml_group_attribute }}"
      emailAttribute: "{{ saml_email_attribute }}"
      noAutoUserCreation: false
      allowUserToAccessProfile: true
      autoRedirect: false
      verifyAudienceRestriction: false
    status_code: [200,201]
    validate_certs: false
  register: saml_config_result

- name: Display Artifactory SAML login URL
  ansible.builtin.debug:
    msg: |
      üîê Artifactory SAML configured successfully
      Login URL: {{ artifactory_base_url }}/ui/login
      Look for "Login via SSO" button
      Status: {{ saml_config_result.status }}
