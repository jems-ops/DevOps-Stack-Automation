---
# Create Test User in Keycloak

- name: Check if test user already exists
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/users?username={{ keycloak_saml_integration_test_user.username }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
    status_code: 200
    validate_certs: false
  register: keycloak_saml_integration_existing_test_users

- name: Create test user if not exists
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/users"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      username: "{{ keycloak_saml_integration_test_user.username }}"
      email: "{{ keycloak_saml_integration_test_user.email }}"
      firstName: "{{ keycloak_saml_integration_test_user.first_name }}"
      lastName: "{{ keycloak_saml_integration_test_user.last_name }}"
      enabled: true
      emailVerified: true
      credentials:
        - type: "password"
          value: "{{ keycloak_saml_integration_test_user.password }}"
          temporary: false
    status_code: [201, 409]
    validate_certs: false
  when: keycloak_saml_integration_existing_test_users.json | length == 0

- name: Get test user ID
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/users?username={{ keycloak_saml_integration_test_user.username }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
    status_code: 200
    validate_certs: false
  register: keycloak_saml_integration_test_user_data

- name: Set test user ID fact
  ansible.builtin.set_fact:
    keycloak_saml_integration_test_user_id: "{{ keycloak_saml_integration_test_user_data.json[0].id }}"

- name: Get parent group with subgroups
  ansible.builtin.include_tasks: common/get_groups.yml

- name: Get parent group ID
  ansible.builtin.set_fact:
    keycloak_saml_integration_user_parent_group_id: "{{ (keycloak_saml_integration_groups_result.json | selectattr('name', 'equalto', keycloak_saml_integration_parent_group) | list)[0].id }}"

- name: Get parent group details with subgroups
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/groups/{{ keycloak_saml_integration_user_parent_group_id }}"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
    status_code: 200
    validate_certs: false
  register: keycloak_saml_integration_parent_group_for_user

- name: Add test user to hierarchical subgroups
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/users/{{ keycloak_saml_integration_test_user_id }}/groups/{{ subgroup_id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
    status_code: [204, 409]
    validate_certs: false
  loop: "{{ keycloak_saml_integration_subgroups | dict2items }}"
  vars:
    subgroup_match: "{{ keycloak_saml_integration_parent_group_for_user.json.subGroups | selectattr('name', 'equalto', item.value.name) | list }}"
    subgroup_id: "{{ subgroup_match[0].id if subgroup_match | length > 0 else '' }}"
  when: subgroup_match | length > 0

- name: Get user's current groups
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/users/{{ keycloak_saml_integration_test_user_id }}/groups"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
    status_code: 200
    validate_certs: false
  register: keycloak_saml_integration_user_current_groups

- name: Display test user information
  ansible.builtin.debug:
    msg:
      - "{{ keycloak_saml_integration_app_type | capitalize }} test user configured:"
      - "  Username: {{ keycloak_saml_integration_test_user.username }}"
      - "  Email: {{ keycloak_saml_integration_test_user.email }}"
      - "  Name: {{ keycloak_saml_integration_test_user.first_name }} {{ keycloak_saml_integration_test_user.last_name }}"
      - "  Password: {{ keycloak_saml_integration_test_user.password }}"
      - "  All Groups: {{ keycloak_saml_integration_user_current_groups.json | map(attribute='path') | list | join(', ') }}"
