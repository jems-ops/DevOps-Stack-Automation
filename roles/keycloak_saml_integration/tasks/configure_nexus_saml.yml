---
# Configure Nexus SAML Authentication
# Note: Nexus Repository Manager 3 requires manual SAML configuration through the UI

- name: Display Nexus SAML configuration instructions
  ansible.builtin.debug:
    msg: |
      ‚ö†Ô∏è  Nexus SAML Configuration Requires Manual Setup

      üìã Keycloak Configuration: COMPLETE ‚úì
      ‚Ä¢ SAML Client Created: {{ keycloak_saml_integration_client.client_id }}
      ‚Ä¢ Client ID (UUID): {{ keycloak_saml_integration_saml_client_id }}
      ‚Ä¢ Hierarchical Groups Created
      ‚Ä¢ Protocol Mappers Configured

      üîß Manual Steps Required in Nexus UI:

      1. Access Nexus: {{ keycloak_saml_integration_app.base_url }}
      2. Login as admin
      3. Navigate to: Administration ‚Üí Security ‚Üí Realms
      4. Click "Create realm" ‚Üí Select "SAML"

      5. Configure SAML Realm:
         ‚Ä¢ Name: Keycloak
         ‚Ä¢ IdP Metadata URL: {{ keycloak_saml_integration_keycloak.admin_api_url }}/realms/{{ keycloak_saml_integration_keycloak.realm }}/protocol/saml/descriptor
         ‚Ä¢ Entity ID: {{ keycloak_saml_integration_client.client_id }}
         ‚Ä¢ Username Attribute: {{ keycloak_saml_integration_nexus_saml.username_attribute }}
         ‚Ä¢ First Name Attribute: {{ keycloak_saml_integration_nexus_saml.first_name_attribute }}
         ‚Ä¢ Last Name Attribute: {{ keycloak_saml_integration_nexus_saml.last_name_attribute }}
         ‚Ä¢ Email Attribute: {{ keycloak_saml_integration_nexus_saml.email_attribute }}
         ‚Ä¢ Groups Attribute: {{ keycloak_saml_integration_nexus_saml.groups_attribute }}

      6. Validate Response Signature: {{ keycloak_saml_integration_nexus_saml.validate_response_signature }}
      7. Validate Assertion Signature: {{ keycloak_saml_integration_nexus_saml.validate_assertion_signature }}

      8. Save and Activate the SAML realm

      9. Map Groups to Roles:
         ‚Ä¢ Navigate to: Administration ‚Üí Security ‚Üí Roles
         ‚Ä¢ Create external role mappings:
           - /{{ keycloak_saml_integration_parent_group }}/{{ keycloak_saml_integration_subgroups.admins.name }} ‚Üí nx-admin
           - /{{ keycloak_saml_integration_parent_group }}/{{ keycloak_saml_integration_subgroups.users.name }} ‚Üí nx-developer

      üîó Useful Resources:
      ‚Ä¢ Nexus SAML Documentation: https://help.sonatype.com/repomanager3/nexus-repository-administration/access-control/saml
      ‚Ä¢ Keycloak SAML Descriptor: {{ keycloak_saml_integration_keycloak.admin_api_url }}/realms/{{ keycloak_saml_integration_keycloak.realm }}/protocol/saml/descriptor

      üë§ Test User Credentials:
      ‚Ä¢ Username: {{ keycloak_saml_integration_test_user.username }}
      ‚Ä¢ Password: {{ keycloak_saml_integration_test_user.password }}
      ‚Ä¢ Groups: /{{ keycloak_saml_integration_parent_group }}/{{ keycloak_saml_integration_subgroups.admins.name }}, /{{ keycloak_saml_integration_parent_group }}/{{ keycloak_saml_integration_subgroups.users.name }}
