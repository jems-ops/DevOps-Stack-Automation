---
# Configure SonarQube SAML Authentication

- name: Stop SonarQube service before configuration
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].service_name }}"
    state: stopped
  become: true

- name: Backup existing sonar.properties
  ansible.builtin.copy:
    src: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}"
    dest: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    owner: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].user }}"
    group: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].group }}"
    mode: '0644'
  become: true

- name: Generate SonarQube SAML configuration block
  ansible.builtin.set_fact:
    keycloak_saml_integration_sonar_saml_config: "{{ lookup('template', 'sonar-saml-config.properties.j2') }}"

- name: Remove old SAML certificate entries
  ansible.builtin.lineinfile:
    path: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}"
    regexp: '^sonar\.auth\.saml\.certificate\.secured='
    state: absent
  become: true

- name: Remove old SAML provider ID entries
  ansible.builtin.lineinfile:
    path: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}"
    regexp: '^sonar\.auth\.saml\.providerId='
    state: absent
  become: true

- name: Remove old SAML login URL entries
  ansible.builtin.lineinfile:
    path: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}"
    regexp: '^sonar\.auth\.saml\.loginUrl='
    state: absent
  become: true

- name: Insert SAML configuration into sonar.properties
  ansible.builtin.blockinfile:
    path: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].home }}/{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].config_file }}"
    block: "{{ keycloak_saml_integration_sonar_saml_config }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Keycloak SAML Configuration"
    owner: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].user }}"
    group: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].group }}"
    mode: '0644'
  become: true

- name: Start SonarQube service after configuration
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].service_name }}"
    state: started
  become: true

- name: Wait for SonarQube to be ready
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_app.base_url }}/api/system/health"
    method: GET
    validate_certs: no
    status_code: 200
  register: keycloak_saml_integration_result
  until: keycloak_saml_integration_result.status == 200
  retries: 30
  delay: 10

- name: Display SonarQube SAML login information
  ansible.builtin.debug:
    msg: "üîê SonarQube SAML Login: {{ keycloak_saml_integration_app.base_url }} (SSO button on login page)"
