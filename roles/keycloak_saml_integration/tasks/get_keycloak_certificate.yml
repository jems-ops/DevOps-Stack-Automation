---
# Get Keycloak SAML Certificate

- name: Get Keycloak SAML descriptor
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/realms/{{ keycloak_saml_integration_keycloak.realm }}/protocol/saml/descriptor"
    method: GET
    return_content: yes
    status_code: 200
    validate_certs: false
  register: keycloak_saml_integration_saml_descriptor

- name: Extract Keycloak certificate from SAML descriptor
  ansible.builtin.set_fact:
    keycloak_saml_integration_keycloak_certificate: "{{ keycloak_saml_integration_saml_descriptor.content | regex_search('<ds:X509Certificate>(.*?)</ds:X509Certificate>', '\\1') | first }}"
    keycloak_saml_integration_certificate: "{{ keycloak_saml_integration_saml_descriptor.content | regex_search('<ds:X509Certificate>(.*?)</ds:X509Certificate>', '\\1') | first }}"

- name: Verify certificate extraction
  ansible.builtin.assert:
    that:
      - keycloak_saml_integration_keycloak_certificate is defined
      - keycloak_saml_integration_keycloak_certificate | length > 0
    fail_msg: "Failed to extract Keycloak certificate from SAML descriptor"
    success_msg: "Successfully extracted Keycloak certificate"
