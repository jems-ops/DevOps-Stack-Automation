---
# Configure Groups in Keycloak

- name: Get existing groups
  ansible.builtin.include_tasks: common/get_groups.yml

- name: Set existing groups fact
  ansible.builtin.set_fact:
    keycloak_saml_integration_existing_groups: "{{ keycloak_saml_integration_groups_result }}"

- name: Create groups (admins and users)
  ansible.builtin.uri:
    url: "{{ keycloak_saml_integration_keycloak.base_url }}/admin/realms/{{ keycloak_saml_integration_keycloak.realm }}/groups"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_saml_integration_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.value.name }}"
      path: "/{{ item.value.name }}"
      attributes:
        description: ["{{ item.value.description }}"]
    status_code: [201, 409]
    validate_certs: false
  loop: "{{ keycloak_saml_integration_groups | dict2items }}"
  when: item.value.name not in (keycloak_saml_integration_existing_groups.json | map(attribute='name') | list)

- name: Get updated groups list
  ansible.builtin.include_tasks: common/get_groups.yml

- name: Set updated groups fact
  ansible.builtin.set_fact:
    keycloak_saml_integration_updated_groups: "{{ keycloak_saml_integration_groups_result }}"

- name: Set group IDs facts
  ansible.builtin.set_fact:
    keycloak_saml_integration_admins_group_id: "{{ (keycloak_saml_integration_updated_groups.json | selectattr('name', 'equalto', keycloak_saml_integration_groups.admins.name) | list)[0].id }}"
    keycloak_saml_integration_users_group_id: "{{ (keycloak_saml_integration_updated_groups.json | selectattr('name', 'equalto', keycloak_saml_integration_groups.users.name) | list)[0].id }}"

- name: Display created groups
  ansible.builtin.debug:
    msg:
      - "Created/verified {{ keycloak_saml_integration_app_type | capitalize }} groups:"
      - "  - {{ keycloak_saml_integration_groups.admins.name }} ({{ keycloak_saml_integration_admins_group_id }})"
      - "  - {{ keycloak_saml_integration_groups.users.name }} ({{ keycloak_saml_integration_users_group_id }})"
