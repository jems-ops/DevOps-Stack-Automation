---
# Generic Keycloak SAML Integration Role Defaults
# This role supports multiple applications (Jenkins, SonarQube, etc.)

# Application Configuration
# Required: Set app_type to 'jenkins' or 'sonarqube'
keycloak_saml_integration_app_type: ""  # jenkins or sonarqube
keycloak_saml_integration_app_name: "{{ keycloak_saml_integration_app_type }}"

# Application URLs (dynamically resolved based on app_type)
keycloak_saml_integration_app:
  host: "{{ lookup('vars', keycloak_saml_integration_app_type + '_hostname', default='localhost') }}"
  port: "{{ 443 if keycloak_saml_integration_use_https else 8080 }}"
  protocol: "{{ 'https' if keycloak_saml_integration_use_https else 'http' }}"
  base_url: "{{ lookup('vars', keycloak_saml_integration_app_type + '_base_url', default='http://localhost:8080') }}"

# Application-specific paths
keycloak_saml_integration_app_config:
  jenkins:
    home: "/var/lib/jenkins"
    config_file: "config.xml"
    service_name: "jenkins"
    user: "jenkins"
    group: "jenkins"
    saml_callback_url: "/securityRealm/finishLogin"
# Keycloak Configuration
keycloak_saml_integration_keycloak:
  host: "{{ keycloak_hostname }}"
  port: 443
  protocol: "https"
  realm: "{{ 'sonar' if keycloak_saml_integration_app_type == 'sonarqube' else keycloak_saml_integration_app_type }}"
  admin_user: "{{ vault_KEYCLOAK_ADMIN_USERNAME }}"
  admin_password: "{{ vault_KEYCLOAK_ADMIN_PASSWORD }}"
  base_url: "{{ keycloak_base_url }}"

# SAML Client Configuration
keycloak_saml_integration_client:
  client_id: "{{ keycloak_saml_integration_app_type }}"
  protocol: "saml"
  enabled: true
  front_channel_logout: true

  # Redirect URIs (dynamically built based on app type)
  redirect_uris:
    - "{{ keycloak_saml_integration_app.base_url }}{{ keycloak_saml_integration_app_config[keycloak_saml_integration_app_type].saml_callback_url }}"
    - "{{ keycloak_saml_integration_app.base_url }}/*"

  web_origins:
    - "{{ keycloak_saml_integration_app.base_url }}"

  base_url: "{{ keycloak_saml_integration_app.base_url }}"
  root_url: "{{ keycloak_saml_integration_app.base_url }}"
  admin_url: "{{ keycloak_saml_integration_app.base_url }}"

  # SAML Attributes
  attributes:
    saml_authnstatement: "true"
    saml_server_signature: "false"
    saml_signature_algorithm: "RSA_SHA256"
    saml_client_signature: "false"
    saml_assertion_signature: "true"
    saml_encrypt: "false"
    saml_force_post_binding: "true"
    saml_name_id_format: "username"
    saml_signing_certificate: ""
    saml_signing_private_key: ""

# Protocol Mappers
keycloak_saml_integration_protocol_mappers:
  - name: "username"
    protocol: "saml"
    protocol_mapper: "saml-user-property-mapper"
    config:
      "attribute.name": "username"
      "attribute.nameformat": "Basic"
      "user.attribute": "username"

  - name: "email"
    protocol: "saml"
    protocol_mapper: "saml-user-property-mapper"
    config:
      "attribute.name": "email"
      "attribute.nameformat": "Basic"
      "user.attribute": "email"

  - name: "name"
    protocol: "saml"
    protocol_mapper: "saml-user-property-mapper"
    config:
      "attribute.name": "name"
      "attribute.nameformat": "Basic"
      "user.attribute": "firstName"

  - name: "groups"
    protocol: "saml"
    protocol_mapper: "saml-group-membership-mapper"
    config:
      "attribute.name": "groups"
      "attribute.nameformat": "Basic"
      "single": "false"
      "full.path": "false"

# Groups Configuration
keycloak_saml_integration_groups:
  admins:
    name: "{{ keycloak_saml_integration_app_type }}-admins"
    description: "{{ keycloak_saml_integration_app_name | capitalize }} Administrators"
  users:
    name: "{{ keycloak_saml_integration_app_type }}-users"
    description: "{{ keycloak_saml_integration_app_name | capitalize }} Users"

# Test User Configuration
keycloak_saml_integration_test_user:
  enabled: true
  username: "{{ keycloak_saml_integration_app_type }}-demo"
  email: "{{ keycloak_saml_integration_app_type }}-demo@example.com"
  first_name: "Demo"
  last_name: "User"
  password: "demo123!"
  groups:
    - "{{ keycloak_saml_integration_groups.users.name }}"
    - "{{ keycloak_saml_integration_groups.admins.name }}"

# SAML Configuration for Applications
keycloak_saml_integration_app_saml:
  enabled: true
  sp_entity_id: "{{ keycloak_saml_integration_client.client_id }}"
  groups_attribute: "groups"
  username_attribute: "username"
  email_attribute: "email"
  full_name_attribute: "displayName"
  force_authentication: false
  maximum_authentication_lifetime: 7776000  # 90 days

# HTTPS Configuration
keycloak_saml_integration_use_https: true

# Logging
keycloak_saml_integration_debug_logging: false
