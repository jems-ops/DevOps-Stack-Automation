---
# SonarQube-Keycloak SAML Integration Role Defaults

# SonarQube Configuration
sonarqube_keycloak_saml_sonarqube:
  host: "{{ sonarqube_host_ip | default(ansible_host) | default(inventory_hostname) }}"
  port: 9000
  protocol: "http"
  config_path: "/opt/sonarqube/conf/sonar.properties"
  service_name: "sonarqube"
  base_url: "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}"

  # SAML Configuration
  saml:
    enabled: true
    application_id: "sonarqube"
    provider_name: "Keycloak SAML"
    provider_id: "{{ keycloak_base_url }}/realms/sonar"
    login_url: "{{ keycloak_base_url }}/realms/sonar/protocol/saml"
    sp_entity_id: "sonarqube"

    # User Attribute Mappings
    user:
      login: "username"
      name: "name"
      email: "email"
      sign_up_enabled: true
      default_group: "sonar-users"

    # Group Mappings
    group:
      name: "groups"

    # Force Authentication
    force_authentication: false

# Keycloak Configuration
sonarqube_keycloak_saml_keycloak:
  host: "{{ keycloak_hostname }}"
  port: 443
  protocol: "https"
  realm: "sonar"
  admin_user: "{{ sonarqube_keycloak_saml_keycloak_admin_user | default('admin') }}"
  admin_password: "{{ sonarqube_keycloak_saml_keycloak_admin_password | default('admin123') }}"
  base_url: "{{ keycloak_base_url }}"

  # SAML Client Configuration
  saml_client:
    client_id: "sonarqube"
    enabled: true
    protocol: "saml"
    front_channel_logout: true
    redirect_uris:
      - "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}/*"
    web_origins:
      - "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}"
    base_url: "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}"
    root_url: "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}"
    admin_url: "{{ sonarqube_host_url | default('http://' + (ansible_host | default(inventory_hostname)) + ':9000') }}"

    # SAML Attributes
    attributes:
      saml_authnstatement: "true"
      saml_server_signature: "false"
      saml_signature_algorithm: "RSA_SHA256"
      saml_client_signature: "false"
      saml_assertion_signature: "true"
      saml_encrypt: "false"
      saml_force_post_binding: "true"
      saml_name_id_format: "username"
      saml_signing_certificate: ""
      saml_signing_private_key: ""

    # Protocol Mappers
    protocol_mappers:
      - name: "username"
        protocol: "saml"
        protocol_mapper: "saml-user-property-mapper"
        consent_required: false
        config:
          attribute_nameformat: "Basic"
          user_attribute: "username"
          attribute_name: "username"

      - name: "email"
        protocol: "saml"
        protocol_mapper: "saml-user-property-mapper"
        consent_required: false
        config:
          attribute_nameformat: "Basic"
          user_attribute: "email"
          attribute_name: "email"

      - name: "name"
        protocol: "saml"
        protocol_mapper: "saml-user-property-mapper"
        consent_required: false
        config:
          attribute_nameformat: "Basic"
          user_attribute: "username"
          attribute_name: "name"

      - name: "groups"
        protocol: "saml"
        protocol_mapper: "saml-group-membership-mapper"
        consent_required: false
        config:
          attribute_nameformat: "Basic"
          attribute_name: "groups"
          single: "false"
          full_path: "false"

# Groups Configuration
sonarqube_keycloak_saml_groups:
  sonar_users:
    name: "sonar-users"
    description: "SonarQube Users Group"

# Test User Configuration (optional)
sonarqube_keycloak_saml_test_user:
  enabled: true
  username: "demo.user"
  password: "demo123!"
  email: "demo@example.com"
  first_name: "Demo"
  last_name: "User"
  groups:
    - "sonar-users"

# Logging
sonarqube_keycloak_saml_debug_logging: false

# Backward compatibility aliases
sonarqube: "{{ sonarqube_keycloak_saml_sonarqube }}"
keycloak: "{{ sonarqube_keycloak_saml_keycloak }}"
groups: "{{ sonarqube_keycloak_saml_groups }}"
test_user: "{{ sonarqube_keycloak_saml_test_user }}"
debug_logging: "{{ sonarqube_keycloak_saml_debug_logging }}"
