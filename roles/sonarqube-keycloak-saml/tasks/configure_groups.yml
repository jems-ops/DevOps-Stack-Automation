---
# Configure Groups in Keycloak

- name: Check if sonar-users group exists
  ansible.builtin.uri:
    url: "{{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{ sonarqube_keycloak_saml_keycloak.realm }}/groups"
    method: GET
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: existing_groups

- name: Find existing sonar-users group
  ansible.builtin.set_fact:
    existing_sonar_users_group: "{{ existing_groups.json | selectattr('name', 'equalto', 'sonar-users') | list }}"

- name: Create sonar-users group if it doesn't exist
  ansible.builtin.uri:
    url: "{{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{ sonarqube_keycloak_saml_keycloak.realm }}/groups"
    method: POST
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "sonar-users"
      path: "/sonar-users"
      attributes: {}
      subGroups: []
    status_code: [201]
  when: existing_sonar_users_group | length == 0

- name: Get updated groups list
  ansible.builtin.uri:
    url: "{{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{ sonarqube_keycloak_saml_keycloak.realm }}/groups"
    method: GET
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: updated_groups

- name: Set sonar-users group ID fact
  ansible.builtin.set_fact:
    sonar_users_group_id: "{{ (updated_groups.json | selectattr('name', 'equalto', 'sonar-users') | list)[0].id }}"

- name: Verify group was created or found
  ansible.builtin.assert:
    that:
      - sonar_users_group_id is defined
      - sonar_users_group_id | length > 0
    fail_msg: "Failed to create or find sonar-users group"
    success_msg: "sonar-users group configured successfully with ID: {{ sonar_users_group_id }}"
