---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - sonarqube_keycloak_saml_sonarqube.host is defined
      - sonarqube_keycloak_saml_keycloak.host is defined
      - sonarqube_keycloak_saml_keycloak.realm is defined
      - sonarqube_keycloak_saml_keycloak.admin_user is defined
      - sonarqube_keycloak_saml_keycloak.admin_password is defined
    fail_msg: "Required variables are not defined. Please check your configuration."
    success_msg: "All required variables are defined."
  tags: ['validate']

- name: Enable debug logging
  ansible.builtin.include_tasks: debug_logging.yml
  when: sonarqube_keycloak_saml_debug_logging | default(false) | bool
  tags: ['debug']

- name: Configure SonarQube SAML settings
  ansible.builtin.include_tasks: configure_sonarqube_saml.yml
  tags: ['sonarqube', 'saml']

- name: Get Keycloak access token
  ansible.builtin.include_tasks: get_keycloak_token.yml
  tags: ['keycloak', 'token']

- name: Create Keycloak SAML client
  ansible.builtin.include_tasks: create_keycloak_saml_client.yml
  tags: ['keycloak', 'saml', 'client']

- name: Configure SAML protocol mappers
  ansible.builtin.include_tasks: configure_protocol_mappers.yml
  tags: ['keycloak', 'saml', 'mappers']

- name: Create and configure groups
  ansible.builtin.include_tasks: configure_groups.yml
  tags: ['keycloak', 'groups']

- name: Create test user (optional)
  ansible.builtin.include_tasks: create_test_user.yml
  when: sonarqube_keycloak_saml_test_user.enabled | default(false) | bool
  tags: ['keycloak', 'test_user']

- name: Get Keycloak certificate
  ansible.builtin.include_tasks: get_keycloak_certificate.yml
  tags: ['keycloak', 'certificate']

- name: Update SonarQube certificate
  ansible.builtin.include_tasks: update_sonarqube_certificate.yml
  tags: ['sonarqube', 'certificate']

- name: Restart SonarQube service
  ansible.builtin.systemd:
    name: "{{ sonarqube_keycloak_saml_sonarqube.service_name }}"
    state: restarted
    enabled: true
  become: true
  notify: wait_for_sonarqube
  tags: ['restart']

- name: Verify SAML configuration
  ansible.builtin.include_tasks: verify_configuration.yml
  tags: ['verify']
