---
# Configure SAML Protocol Mappers

- name: Get existing protocol mappers
  ansible.builtin.uri:
    url: >-
      {{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{-
      sonarqube_keycloak_saml_keycloak.realm }}/clients/{{-
      saml_client_id }}/protocol-mappers/models
    method: GET
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: existing_mappers

- name: Delete existing protocol mappers
  ansible.builtin.uri:
    url: >-
      {{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{-
      sonarqube_keycloak_saml_keycloak.realm }}/clients/{{-
      saml_client_id }}/protocol-mappers/models/{{ item.id }}
    method: DELETE
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [204]
  loop: "{{ existing_mappers.json }}"
  when: existing_mappers.json | length > 0

- name: Create protocol mappers
  ansible.builtin.uri:
    url: >-
      {{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{-
      sonarqube_keycloak_saml_keycloak.realm }}/clients/{{-
      saml_client_id }}/protocol-mappers/models
    method: POST
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.name }}"
      protocol: "{{ item.protocol }}"
      protocolMapper: "{{ item.protocol_mapper }}"
      consentRequired: "{{ item.consent_required }}"
      config:
        "attribute.nameformat": "{{ item.config.attribute_nameformat }}"
        "user.attribute": "{{ item.config.user_attribute | default(omit) }}"
        "attribute.name": "{{ item.config.attribute_name }}"
        "single": "{{ item.config.single | default(omit) }}"
        "full.path": "{{ item.config.full_path | default(omit) }}"
    status_code: [201]
  loop: "{{ sonarqube_keycloak_saml_keycloak.saml_client.protocol_mappers }}"

- name: Verify protocol mappers were created
  ansible.builtin.uri:
    url: >-
      {{ sonarqube_keycloak_saml_keycloak.base_url }}/admin/realms/{{-
      sonarqube_keycloak_saml_keycloak.realm }}/clients/{{-
      saml_client_id }}/protocol-mappers/models
    method: GET
    validate_certs: false
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: created_mappers

- name: Confirm all mappers were created
  ansible.builtin.assert:
    that:
      - created_mappers.json | length == sonarqube_keycloak_saml_keycloak.saml_client.protocol_mappers | length
    fail_msg: "Not all protocol mappers were created successfully"
    success_msg: "All {{ sonarqube_keycloak_saml_keycloak.saml_client.protocol_mappers | length }} protocol mappers created successfully"
