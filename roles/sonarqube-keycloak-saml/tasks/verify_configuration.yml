---
# Verify SAML Configuration

- name: Wait for SonarQube to be ready
  ansible.builtin.uri:
    url: "{{ sonarqube.base_url }}/api/system/status"
    method: GET
    status_code: [200]
    return_content: true
  register: sonarqube_status
  until: "sonarqube_status.json is defined and sonarqube_status.json.status == 'UP'"
  retries: 30
  delay: 10
  failed_when: false

- name: Verify SonarQube SAML initiation endpoint
  ansible.builtin.uri:
    url: "{{ sonarqube.base_url }}/sessions/init/saml"
    method: HEAD
    validate_certs: false
    follow_redirects: none
    status_code: [302]
  register: saml_init_test

- name: Check that SAML initiation redirects to Keycloak
  ansible.builtin.assert:
    that:
      - saml_init_test.location is defined
      - keycloak.base_url in saml_init_test.location
      - keycloak.realm in saml_init_test.location
      - "'protocol/saml' in saml_init_test.location"
    fail_msg: "SAML initiation does not redirect to Keycloak properly"
    success_msg: "SAML initiation correctly redirects to Keycloak"

- name: Display configuration summary
  ansible.builtin.debug:
    msg: |
      === SonarQube-Keycloak SAML Integration Summary ===

      âœ… SonarQube Configuration:
         - URL: {{ sonarqube.base_url }}
         - SAML Enabled: {{ sonarqube.saml.enabled }}
         - Force Authentication: {{ sonarqube.saml.force_authentication }}

      âœ… Keycloak Configuration:
         - URL: {{ keycloak.base_url }}
         - Realm: {{ keycloak.realm }}
         - SAML Client ID: {{ keycloak.saml_client.client_id }}
         - HTTP POST Binding: {{ keycloak.saml_client.attributes.saml_force_post_binding }}

      âœ… Protocol Mappers: {{ keycloak.saml_client.protocol_mappers | length }} configured

      âœ… Groups:
         - sonar-users group created

      ðŸ”— Access SonarQube: {{ sonarqube.base_url }}
      ðŸ”‘ Click 'Log in with Keycloak SAML' to test SSO
      {% if test_user.enabled %}

      ðŸ‘¤ Test User Created:
         - Username: {{ test_user.username }}
         - Password: {{ test_user.password }}
         - Group: sonar-users
      {% endif %}
