---
# Create Keycloak SAML Client

- name: Check if SAML client already exists
  ansible.builtin.uri:
    url: "{{ keycloak.base_url }}/admin/realms/{{ keycloak.realm }}/clients"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: existing_clients

- name: Find existing SAML client
  ansible.builtin.set_fact:
    existing_saml_client: "{{ existing_clients.json | selectattr('clientId', 'equalto', keycloak.saml_client.client_id) | list }}"

- name: Delete existing SAML client if it exists
  ansible.builtin.uri:
    url: "{{ keycloak.base_url }}/admin/realms/{{ keycloak.realm }}/clients/{{ existing_saml_client[0].id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [204]
  when: existing_saml_client | length > 0

- name: Create SAML client
  ansible.builtin.uri:
    url: "{{ keycloak.base_url }}/admin/realms/{{ keycloak.realm }}/clients"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      clientId: "{{ keycloak.saml_client.client_id }}"
      protocol: "{{ keycloak.saml_client.protocol }}"
      enabled: "{{ keycloak.saml_client.enabled }}"
      frontchannelLogout: "{{ keycloak.saml_client.front_channel_logout }}"
      redirectUris: "{{ keycloak.saml_client.redirect_uris }}"
      webOrigins: "{{ keycloak.saml_client.web_origins }}"
      baseUrl: "{{ keycloak.saml_client.base_url }}"
      rootUrl: "{{ keycloak.saml_client.root_url }}"
      adminUrl: "{{ keycloak.saml_client.admin_url }}"
      attributes:
        "saml.authnstatement": "{{ keycloak.saml_client.attributes.saml_authnstatement }}"
        "saml.server.signature": "{{ keycloak.saml_client.attributes.saml_server_signature }}"
        "saml.signature.algorithm": "{{ keycloak.saml_client.attributes.saml_signature_algorithm }}"
        "saml.client.signature": "{{ keycloak.saml_client.attributes.saml_client_signature }}"
        "saml.assertion.signature": "{{ keycloak.saml_client.attributes.saml_assertion_signature }}"
        "saml.encrypt": "{{ keycloak.saml_client.attributes.saml_encrypt }}"
        "saml.force.post.binding": "{{ keycloak.saml_client.attributes.saml_force_post_binding }}"
        "saml_name_id_format": "{{ keycloak.saml_client.attributes.saml_name_id_format }}"
        "saml.signing.certificate": "{{ keycloak.saml_client.attributes.saml_signing_certificate }}"
        "saml.signing.private.key": "{{ keycloak.saml_client.attributes.saml_signing_private_key }}"
      defaultClientScopes: []
      optionalClientScopes: []
    status_code: [201]
  register: create_client_response

- name: Get created client details
  ansible.builtin.uri:
    url: "{{ keycloak.base_url }}/admin/realms/{{ keycloak.realm }}/clients"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [200]
  register: updated_clients

- name: Set SAML client ID fact
  ansible.builtin.set_fact:
    saml_client_id: "{{ (updated_clients.json | selectattr('clientId', 'equalto', keycloak.saml_client.client_id) | list)[0].id }}"

- name: Verify SAML client was created
  ansible.builtin.assert:
    that:
      - saml_client_id is defined
      - saml_client_id | length > 0
    fail_msg: "Failed to create or find SAML client"
    success_msg: "SAML client created successfully with ID: {{ saml_client_id }}"
