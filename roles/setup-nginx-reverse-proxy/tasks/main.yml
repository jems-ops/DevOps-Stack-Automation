---
- name: Display nginx reverse proxy setup information
  debug:
    msg: |
      ğŸŒ Setting up Dynamic Nginx Reverse Proxy
      ğŸ“… Setup time: {{ ansible_date_time.iso8601 }}
      ğŸ–¥ï¸  Target host: {{ inventory_hostname }}
      ğŸ“Š Backend count: {{ site_backends | length }}
      ğŸ”— Backends: {{ site_backends | map(attribute='server_name') | join(', ') }}

- name: Update package cache
  dnf:
    update_cache: yes

- name: Install nginx
  dnf:
    name: nginx
    state: present

- name: Remove default nginx configuration
  file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  notify: restart nginx

- name: Create nginx configuration directory
  file:
    path: "{{ nginx_config_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create nginx log directory
  file:
    path: /var/log/nginx
    state: directory
    owner: nginx
    group: nginx
    mode: '0755'

- name: Deploy dynamic nginx configuration for all backends
  template:
    src: "dynamic-backends.conf.j2"
    dest: "{{ nginx_config_path }}/dynamic-backends.conf"
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify:
    - test nginx config
    - restart nginx

- name: Test nginx configuration syntax
  command: nginx -t
  register: nginx_config_test
  changed_when: false

- name: Configure firewall for nginx
  firewalld:
    port: "{{ item }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - 80
    - 443
  ignore_errors: yes

- name: Configure SELinux for nginx proxy
  seboolean:
    name: httpd_can_network_connect
    state: yes
    persistent: yes
  ignore_errors: yes

- name: Ensure nginx service is enabled and started
  systemd:
    name: nginx
    enabled: "{{ nginx_service_enabled }}"
    state: "{{ nginx_service_state }}"

- name: Test backend connectivity for all configured backends
  uri:
    url: "http://{{ item.ip }}:{{ item.port }}"
    method: GET
    timeout: 10
  loop: "{{ site_backends }}"
  loop_control:
    label: "{{ item.server_name }}"
  register: backend_tests
  ignore_errors: yes

- name: Test nginx HTTPS proxy response for each backend
  uri:
    url: "https://{{ item.server_name }}"
    method: GET
    timeout: 10
    validate_certs: false
  loop: "{{ site_backends }}"
  loop_control:
    label: "{{ item.server_name }}"
  register: nginx_proxy_tests
  ignore_errors: yes

- name: Display dynamic nginx reverse proxy setup completion
  debug:
    msg: |
      âœ… Dynamic Nginx Reverse Proxy Setup Complete!
      
      ğŸ“‹ Configuration Summary:
      â€¢ Backends configured: {{ site_backends | length }}
      â€¢ Config file: {{ nginx_config_path }}/dynamic-backends.conf
      â€¢ SSL enabled: Yes (HTTPS + HTTP redirect)
      
      ğŸŒ Configured Services:
      {% for backend in site_backends %}
      â€¢ {{ backend.server_name }} â†’ {{ backend.ip }}:{{ backend.port }}
      {% endfor %}
      
      ğŸ”’ Access URLs (HTTPS):
      {% for backend in site_backends %}
      â€¢ https://{{ backend.server_name }}
      {% endfor %}
      
      ğŸ”§ Next Steps:
      1. Ensure DNS/hosts entries are configured for all domains
      2. Access services via HTTPS URLs above
      3. HTTP traffic automatically redirects to HTTPS
