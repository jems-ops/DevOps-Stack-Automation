# Dynamic Backend Configuration
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
{% set exclude = nginx_exclude_server_names | default([]) %}
{% set backends = site_backends | rejectattr('server_name', 'in', exclude) | list %}
# Configured backends: {{ backends | length }}

{% for backend in backends %}
{% set service_name = (backend.server_name if backend.server_name is string else backend.server_name[0]).split('.')[0] %}
# Upstream for {{ backend.server_name }}
upstream {{ service_name }}_backend {
  keepalive {{ nginx_keepalive_connections }};
  server {{ backend.ip }}:{{ backend.port }};
}

{% endfor %}

{% if 'jenkins' in (backends | map(attribute='server_name') | join(' ')) %}
# Required for Jenkins websocket agents
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

{% endif %}
{% for backend in backends %}
{% set server_names = backend.server_name if backend.server_name is iterable and backend.server_name is not string else [backend.server_name] %}
{% set service_name = (server_names[0]).split('.')[0] %}
# HTTP server for {{ backend.server_name }}
server {
  listen          {{ nginx_listen_port }};
  server_name     {{ server_names | join(' ') }};

  # Basic security headers (no SSL)
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;

  access_log {{ nginx_access_log }};
  error_log  {{ nginx_error_log }};

  # Pass through headers that Nginx considers invalid
  ignore_invalid_headers off;

{% if site_rewrite_rule is defined %}
  # Global rewrite rule
  rewrite {{ site_rewrite_rule }};
{% endif %}

{% if 'jenkins' in server_names %}
  # Jenkins-specific configuration
  root {{ jenkins_war_root }};

  location ~ "^\/static\/[0-9a-fA-F]{8}\/(.*)$" {
    # rewrite all static files into requests to the root
    rewrite "^\/static\/[0-9a-fA-F]{8}\/(.*)$" /$1 last;
  }

  location /userContent {
    # have nginx handle all the static requests to userContent folder
    root {{ jenkins_home }}/;
    if (!-f $request_filename){
      rewrite (.*) /$1 last;
      break;
    }
    sendfile on;
  }

{% endif %}
  location / {
{% if backend.rewrite_rule is defined %}
    # Per-backend rewrite rule
    rewrite {{ backend.rewrite_rule }};
{% endif %}
{% if 'jenkins' in server_names %}
    sendfile off;
{% endif %}
    proxy_pass         http://{{ service_name }}_backend;
    proxy_redirect     default;
    proxy_http_version 1.1;

{% if 'jenkins' in server_names %}
    # Required for Jenkins websocket agents
    proxy_set_header   Connection        $connection_upgrade;
    proxy_set_header   Upgrade           $http_upgrade;
{% endif %}

    proxy_set_header   Host              $http_host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_max_temp_file_size 0;

    # Upload size and timeouts
    client_max_body_size       {{ nginx_client_max_body_size }};
    client_body_buffer_size    {{ nginx_client_body_buffer_size }};

    proxy_connect_timeout      {{ nginx_proxy_connect_timeout }};
    proxy_send_timeout         {{ nginx_proxy_send_timeout }};
    proxy_read_timeout         {{ nginx_proxy_read_timeout }};
{% if 'jenkins' in server_names %}
    proxy_request_buffering    off; # Required for Jenkins HTTP CLI commands
{% else %}
    proxy_request_buffering    on;  # SonarQube can handle request buffering
{% endif %}
  }
}

{% endfor %}

# Default server block for requests without matching Host header
server {
  listen          {{ nginx_listen_port }} default_server;
  server_name     _;

  # Return a simple status page
  location / {
    return 200 'Nginx Reverse Proxy - Available services: {{ backends | map(attribute="server_name") | join(", ") }}';
    add_header Content-Type text/plain;
  }
}
