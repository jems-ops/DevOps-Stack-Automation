---
# Configure SAML Protocol Mappers

- name: Get existing protocol mappers for Jenkins SAML client
  ansible.builtin.uri:
    url: "{{ jenkins_keycloak_saml_keycloak.base_url }}/admin/realms/{{ jenkins_keycloak_saml_keycloak.realm }}/clients/{{ saml_client_id }}/protocol-mappers/models"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: 200
    validate_certs: false
  register: existing_mappers

- name: Delete existing protocol mappers
  ansible.builtin.uri:
    url: "{{ jenkins_keycloak_saml_keycloak.base_url }}/admin/realms/{{ jenkins_keycloak_saml_keycloak.realm }}/clients/{{ saml_client_id }}/protocol-mappers/models/{{ item.id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: [204]
    validate_certs: false
  loop: "{{ existing_mappers.json }}"
  when: existing_mappers.json | length > 0

- name: Create SAML protocol mappers
  ansible.builtin.uri:
    url: "{{ jenkins_keycloak_saml_keycloak.base_url }}/admin/realms/{{ jenkins_keycloak_saml_keycloak.realm }}/clients/{{ saml_client_id }}/protocol-mappers/models"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ item.name }}"
      protocol: "{{ item.protocol }}"
      protocolMapper: "{{ item.protocol_mapper }}"
      config: "{{ item.config }}"
    status_code: [201]
    validate_certs: false
  loop: "{{ jenkins_keycloak_saml_keycloak.saml_client.protocol_mappers }}"
  register: created_mappers

- name: Verify protocol mappers creation
  ansible.builtin.uri:
    url: "{{ jenkins_keycloak_saml_keycloak.base_url }}/admin/realms/{{ jenkins_keycloak_saml_keycloak.realm }}/clients/{{ saml_client_id }}/protocol-mappers/models"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: 200
    validate_certs: false
  register: verification_mappers

- name: Assert protocol mappers were created successfully
  ansible.builtin.assert:
    that:
      - verification_mappers.json | length == jenkins_keycloak_saml_keycloak.saml_client.protocol_mappers | length
    fail_msg: "Not all protocol mappers were created successfully"
    success_msg: "All {{ jenkins_keycloak_saml_keycloak.saml_client.protocol_mappers | length }} protocol mappers created successfully"
