---
# Main tasks for Jenkins-Keycloak SAML Integration

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - jenkins_keycloak_saml_jenkins.host is defined
      - jenkins_keycloak_saml_keycloak.host is defined
      - jenkins_keycloak_saml_keycloak.realm is defined
      - jenkins_keycloak_saml_keycloak.admin_user is defined
      - jenkins_keycloak_saml_keycloak.admin_password is defined
    fail_msg: "Required variables are not defined. Please check your configuration."
    success_msg: "All required variables are defined."
  tags: ['validate']

- name: Enable debug logging
  ansible.builtin.include_tasks: debug_logging.yml
  when: jenkins_keycloak_saml_debug_logging | default(false) | bool
  tags: ['debug']

- name: Get Keycloak access token
  ansible.builtin.include_tasks: get_keycloak_token.yml
  tags: ['keycloak', 'token']

- name: Create Keycloak SAML client for Jenkins
  ansible.builtin.include_tasks: create_keycloak_saml_client.yml
  tags: ['keycloak', 'saml', 'client']

- name: Configure SAML protocol mappers
  ansible.builtin.include_tasks: configure_protocol_mappers.yml
  tags: ['keycloak', 'saml', 'mappers']

- name: Create and configure groups
  ansible.builtin.include_tasks: configure_groups.yml
  tags: ['keycloak', 'groups']

- name: Create test user (optional)
  ansible.builtin.include_tasks: create_test_user.yml
  when: jenkins_keycloak_saml_test_user.enabled | default(false) | bool
  tags: ['keycloak', 'test_user']

- name: Get Keycloak certificate
  ansible.builtin.include_tasks: get_keycloak_certificate.yml
  tags: ['keycloak', 'certificate']

- name: Configure Jenkins SAML authentication
  ansible.builtin.include_tasks: configure_jenkins_saml.yml
  tags: ['jenkins', 'saml']

- name: Restart Jenkins service
  ansible.builtin.systemd:
    name: "{{ jenkins_keycloak_saml_jenkins.service_name }}"
    state: restarted
    enabled: true
  become: true
  tags: ['restart']

- name: Wait for Jenkins to start
  ansible.builtin.wait_for:
    port: "{{ jenkins_keycloak_saml_jenkins.port }}"
    state: started
    timeout: 300
  tags: ['restart']

- name: Verify SAML configuration
  ansible.builtin.include_tasks: verify_configuration.yml
  tags: ['verify']
