---
# Apply SAML Configuration to Application
# This task file generates and applies SAML configuration

- name: Ensure temporary directory exists
  local_action:
    module: ansible.builtin.file
    path: "{{ common_saml_tmp_dir }}"
    state: directory
    mode: '0755'
  run_once: true

- name: Generate SAML configuration from template
  local_action:
    module: ansible.builtin.template
    src: "saml-config.{{ common_saml_app_type }}.j2"
    dest: "{{ common_saml_tmp_dir }}/saml-config-{{ inventory_hostname }}.{{ common_saml_app_type }}"
    mode: '0644'

- name: Read generated SAML configuration
  local_action:
    module: ansible.builtin.slurp
    src: "{{ common_saml_tmp_dir }}/saml-config-{{ inventory_hostname }}.{{ common_saml_app_type }}"
  register: common_saml_generated_config

- name: Backup current application configuration
  ansible.builtin.copy:
    src: "{{ common_saml_config_path }}"
    dest: "{{ common_saml_config_path }}.backup-{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: preserve
  become: true
  when: common_saml_config_backup | default(true) | bool

- name: Update application configuration with SAML settings
  ansible.builtin.blockinfile:
    path: "{{ common_saml_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED SAML CONFIGURATION - {{ common_saml_app_name | upper }}"
    block: "{{ common_saml_generated_config['content'] | b64decode }}"
    create: false
    backup: false
  become: true
  notify: "restart_{{ common_saml_service_name }}"
  when: common_saml_service_name is defined and common_saml_service_name | length > 0

- name: Update application configuration with SAML settings (no service restart)
  ansible.builtin.blockinfile:
    path: "{{ common_saml_config_path }}"
    marker: "# {mark} ANSIBLE MANAGED SAML CONFIGURATION - {{ common_saml_app_name | upper }}"
    block: "{{ common_saml_generated_config['content'] | b64decode }}"
    create: false
    backup: false
  become: true
  when: common_saml_service_name is not defined or common_saml_service_name | length == 0

- name: Display configuration update result
  ansible.builtin.debug:
    msg: "SAML configuration successfully applied to {{ common_saml_config_path }}"
  when: common_saml_debug | default(false) | bool
