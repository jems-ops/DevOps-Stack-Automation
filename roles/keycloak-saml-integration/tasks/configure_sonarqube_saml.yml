---
# Configure SonarQube SAML Authentication

- name: Stop SonarQube service before configuration
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_app_config[keycloak_saml_app_type].service_name }}"
    state: stopped
  become: yes

- name: Backup existing sonar.properties
  ansible.builtin.copy:
    src: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}"
    dest: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    owner: "{{ keycloak_saml_app_config[keycloak_saml_app_type].user }}"
    group: "{{ keycloak_saml_app_config[keycloak_saml_app_type].group }}"
    mode: '0644'
  become: yes

- name: Generate SonarQube SAML configuration block
  ansible.builtin.set_fact:
    sonar_saml_config: "{{ lookup('template', 'sonar-saml-config.properties.j2') }}"

- name: Insert SAML configuration into sonar.properties
  ansible.builtin.blockinfile:
    path: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}"
    block: "{{ sonar_saml_config }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Keycloak SAML Configuration"
    owner: "{{ keycloak_saml_app_config[keycloak_saml_app_type].user }}"
    group: "{{ keycloak_saml_app_config[keycloak_saml_app_type].group }}"
    mode: '0644'
  become: yes

- name: Start SonarQube service after configuration
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_app_config[keycloak_saml_app_type].service_name }}"
    state: started
  become: yes

- name: Wait for SonarQube to be ready
  ansible.builtin.uri:
    url: "{{ keycloak_saml_app.base_url }}/api/system/health"
    method: GET
    validate_certs: no
    status_code: 200
  register: result
  until: result.status == 200
  retries: 30
  delay: 10

- name: Display SonarQube SAML login information
  ansible.builtin.debug:
    msg: "üîê SonarQube SAML Login: {{ keycloak_saml_app.base_url }} (SSO button on login page)"
