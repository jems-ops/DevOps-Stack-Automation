---
# Configure Jenkins SAML Authentication

- name: Stop Jenkins service for configuration update
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_app_config[keycloak_saml_app_type].service_name }}"
    state: stopped
  become: true

- name: Wait for Jenkins to stop
  ansible.builtin.wait_for:
    port: 8080
    host: 127.0.0.1
    state: stopped
    timeout: 60

- name: Backup existing Jenkins config.xml
  ansible.builtin.copy:
    src: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}"
    dest: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    owner: "{{ keycloak_saml_app_config[keycloak_saml_app_type].user }}"
    group: "{{ keycloak_saml_app_config[keycloak_saml_app_type].group }}"
    mode: '0644'
  become: true

- name: Generate complete Jenkins configuration with SAML from template
  ansible.builtin.template:
    src: jenkins-saml-config.xml.j2
    dest: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/{{ keycloak_saml_app_config[keycloak_saml_app_type].config_file }}"
    owner: "{{ keycloak_saml_app_config[keycloak_saml_app_type].user }}"
    group: "{{ keycloak_saml_app_config[keycloak_saml_app_type].group }}"
    mode: '0644'
    backup: yes
  become: true

- name: Remove cached Keycloak metadata file to force refresh
  ansible.builtin.file:
    path: "{{ keycloak_saml_app_config[keycloak_saml_app_type].home }}/org.jenkinsci.plugins.saml.SamlSecurityRealm.xml"
    state: absent
  become: true
  ignore_errors: true

- name: Start Jenkins service
  ansible.builtin.systemd:
    name: "{{ keycloak_saml_app_config[keycloak_saml_app_type].service_name }}"
    state: started
    enabled: yes
  become: true

- name: Wait for Jenkins to start
  ansible.builtin.wait_for:
    port: 8080
    host: 127.0.0.1
    state: started
    timeout: 300

- name: Display Jenkins SAML login URL
  ansible.builtin.debug:
    msg: "üîê Jenkins SAML Login: {{ keycloak_saml_app.base_url }}/securityRealm/commenceLogin"
