---
# Create Keycloak SAML Client for Jenkins

- name: Check if Jenkins SAML client already exists
  ansible.builtin.uri:
    url: "{{ keycloak_saml_keycloak.base_url }}/admin/realms/{{ keycloak_saml_keycloak.realm }}/clients"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: 200
    validate_certs: false
  register: existing_clients

- name: Set existing client fact
  ansible.builtin.set_fact:
    existing_saml_client: "{{ existing_clients.json | selectattr('clientId', 'equalto', keycloak_saml_client.client_id) | list }}"

- name: Update existing Jenkins SAML client
  ansible.builtin.uri:
    url: "{{ keycloak_saml_keycloak.base_url }}/admin/realms/{{ keycloak_saml_keycloak.realm }}/clients/{{ existing_saml_client[0].id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      clientId: "{{ keycloak_saml_client.client_id }}"
      protocol: "{{ keycloak_saml_client.protocol }}"
      enabled: "{{ keycloak_saml_client.enabled }}"
      frontchannelLogout: "{{ keycloak_saml_client.front_channel_logout }}"
      redirectUris: "{{ keycloak_saml_client.redirect_uris }}"
      webOrigins: "{{ keycloak_saml_client.web_origins }}"
      baseUrl: "{{ keycloak_saml_client.base_url }}"
      rootUrl: "{{ keycloak_saml_client.root_url }}"
      adminUrl: "{{ keycloak_saml_client.admin_url }}"
      attributes:
        "saml.authnstatement": "{{ keycloak_saml_client.attributes.saml_authnstatement }}"
        "saml.server.signature": "{{ keycloak_saml_client.attributes.saml_server_signature }}"
        "saml.signature.algorithm": "{{ keycloak_saml_client.attributes.saml_signature_algorithm }}"
        "saml.client.signature": "{{ keycloak_saml_client.attributes.saml_client_signature }}"
        "saml.assertion.signature": "{{ keycloak_saml_client.attributes.saml_assertion_signature }}"
        "saml.encrypt": "{{ keycloak_saml_client.attributes.saml_encrypt }}"
        "saml.force.post.binding": "{{ keycloak_saml_client.attributes.saml_force_post_binding }}"
        "saml_name_id_format": "{{ keycloak_saml_client.attributes.saml_name_id_format }}"
        "saml.signing.certificate": "{{ keycloak_saml_client.attributes.saml_signing_certificate }}"
        "saml.signing.private.key": "{{ keycloak_saml_client.attributes.saml_signing_private_key }}"
    status_code: [200, 204]
    validate_certs: false
  when: existing_saml_client | length > 0

- name: Create new Jenkins SAML client
  ansible.builtin.uri:
    url: "{{ keycloak_saml_keycloak.base_url }}/admin/realms/{{ keycloak_saml_keycloak.realm }}/clients"
    method: POST
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      clientId: "{{ keycloak_saml_client.client_id }}"
      protocol: "{{ keycloak_saml_client.protocol }}"
      enabled: "{{ keycloak_saml_client.enabled }}"
      frontchannelLogout: "{{ keycloak_saml_client.front_channel_logout }}"
      redirectUris: "{{ keycloak_saml_client.redirect_uris }}"
      webOrigins: "{{ keycloak_saml_client.web_origins }}"
      baseUrl: "{{ keycloak_saml_client.base_url }}"
      rootUrl: "{{ keycloak_saml_client.root_url }}"
      adminUrl: "{{ keycloak_saml_client.admin_url }}"
      attributes:
        "saml.authnstatement": "{{ keycloak_saml_client.attributes.saml_authnstatement }}"
        "saml.server.signature": "{{ keycloak_saml_client.attributes.saml_server_signature }}"
        "saml.signature.algorithm": "{{ keycloak_saml_client.attributes.saml_signature_algorithm }}"
        "saml.client.signature": "{{ keycloak_saml_client.attributes.saml_client_signature }}"
        "saml.assertion.signature": "{{ keycloak_saml_client.attributes.saml_assertion_signature }}"
        "saml.encrypt": "{{ keycloak_saml_client.attributes.saml_encrypt }}"
        "saml.force.post.binding": "{{ keycloak_saml_client.attributes.saml_force_post_binding }}"
        "saml_name_id_format": "{{ keycloak_saml_client.attributes.saml_name_id_format }}"
        "saml.signing.certificate": "{{ keycloak_saml_client.attributes.saml_signing_certificate }}"
        "saml.signing.private.key": "{{ keycloak_saml_client.attributes.saml_signing_private_key }}"
    status_code: [201, 409]
    validate_certs: false
  when: existing_saml_client | length == 0

- name: Get updated client list to retrieve client ID
  ansible.builtin.uri:
    url: "{{ keycloak_saml_keycloak.base_url }}/admin/realms/{{ keycloak_saml_keycloak.realm }}/clients"
    method: GET
    headers:
      Authorization: "Bearer {{ keycloak_access_token }}"
    status_code: 200
    validate_certs: false
  register: updated_clients

- name: Set SAML client ID fact
  ansible.builtin.set_fact:
    saml_client_id: "{{ (updated_clients.json | selectattr('clientId', 'equalto', keycloak_saml_client.client_id) | list)[0].id }}"

- name: Verify Jenkins SAML client creation
  ansible.builtin.debug:
    msg: "Jenkins SAML client '{{ keycloak_saml_client.client_id }}' configured successfully with ID: {{ saml_client_id }}"
