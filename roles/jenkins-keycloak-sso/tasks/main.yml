---
# Jenkins-Keycloak SSO Integration Tasks

- name: Display SSO configuration information
  debug:
    msg: |
      ğŸ” Jenkins-Keycloak SSO Integration
      ğŸ“… Execution time: {{ ansible_date_time.iso8601 }}
      ğŸ–¥ï¸  Jenkins server: {{ groups['jenkins'][0] }}
      ğŸ”‘ Keycloak server: {{ groups['keycloak'][0] }}
      ğŸŒ Nginx proxy: {{ groups['nginx'][0] }}
      ğŸ›ï¸  Realm: {{ sso_realm_name }}
      ğŸ‘¤ Client ID: {{ jenkins_client_id }}

# Prerequisites Check
- name: Check if Keycloak is accessible
  uri:
    url: "{{ keycloak_admin_url }}/"
    method: GET
    timeout: "{{ keycloak_api_timeout }}"
  register: keycloak_health_check
  retries: "{{ keycloak_api_retries }}"
  delay: 5

- name: Fail if Keycloak is not accessible
  fail:
    msg: "Keycloak server at {{ keycloak_admin_url }} is not accessible"
  when: keycloak_health_check.status != 200

- name: Check if Jenkins is accessible
  uri:
    url: "{{ jenkins_base_url }}/login"
    method: GET
    timeout: 30
  register: jenkins_health_check
  retries: 3
  delay: 5

- name: Fail if Jenkins is not accessible
  fail:
    msg: "Jenkins server at {{ jenkins_base_url }} is not accessible"
  when: jenkins_health_check.status != 200

# Keycloak Configuration
- name: Create temporary directory for configuration files
  tempfile:
    state: directory
    suffix: jenkins_sso
  register: temp_dir
  delegate_to: localhost
  run_once: true

- name: Generate Keycloak configuration file
  template:
    src: keycloak-config.json.j2
    dest: "{{ temp_dir.path }}/keycloak-config.json"
  delegate_to: localhost
  run_once: true

- name: Install Python requests module on Keycloak server
  pip:
    name: requests
    state: present
  delegate_to: "{{ groups['keycloak'][0] }}"

- name: Copy Keycloak configuration script to server
  copy:
    src: configure_keycloak.py
    dest: /tmp/configure_keycloak.py
    mode: '0755'
  delegate_to: "{{ groups['keycloak'][0] }}"

- name: Copy Keycloak configuration file to server
  copy:
    src: "{{ temp_dir.path }}/keycloak-config.json"
    dest: /tmp/keycloak-config.json
    mode: '0644'
  delegate_to: "{{ groups['keycloak'][0] }}"

- name: Configure Keycloak for Jenkins SSO
  command: >
    python3 /tmp/configure_keycloak.py
    --config-file /tmp/keycloak-config.json
    --keycloak-url {{ keycloak_admin_url }}
    --admin-user {{ keycloak_admin_user }}
    --admin-password {{ keycloak_admin_password }}
    --timeout {{ keycloak_api_timeout }}
    --retries {{ keycloak_api_retries }}
  register: keycloak_config_result
  delegate_to: "{{ groups['keycloak'][0] }}"
  changed_when: "'Created' in keycloak_config_result.stdout"

- name: Display Keycloak configuration result
  debug:
    var: keycloak_config_result.stdout_lines

# Jenkins Configuration
- name: Note about OIDC plugin requirement
  debug:
    msg: |
      ğŸ“ Note: This configuration requires the OpenID Connect Authentication plugin (oic-auth).
      If Jenkins fails to start after configuration, install the plugin manually:
      1. Go to Manage Jenkins > Plugins
      2. Search for "OpenID Connect Authentication"
      3. Install and restart Jenkins
      4. Re-run this playbook

- name: Stop Jenkins service for configuration
  command: /bin/systemctl stop jenkins
  delegate_to: "{{ groups['jenkins'][0] }}"
  become: yes
  vars:
    ansible_ssh_pipelining: false

- name: Backup existing Jenkins config
  copy:
    src: /var/lib/jenkins/config.xml
    dest: "/var/lib/jenkins/config.xml.backup.{{ ansible_date_time.epoch }}"
    remote_src: yes
    owner: jenkins
    group: jenkins
    mode: '0644'
  delegate_to: "{{ groups['jenkins'][0] }}"
  become: yes

- name: Deploy Jenkins OIDC security configuration
  template:
    src: jenkins-security-config.xml.j2
    dest: /var/lib/jenkins/config.xml
    owner: jenkins
    group: jenkins
    mode: '0644'
    backup: yes
  delegate_to: "{{ groups['jenkins'][0] }}"
  become: yes
  notify: restart jenkins

- name: Start Jenkins service
  command: /bin/systemctl start jenkins
  delegate_to: "{{ groups['jenkins'][0] }}"
  become: yes

- name: Enable Jenkins service
  command: /bin/systemctl enable jenkins
  delegate_to: "{{ groups['jenkins'][0] }}"
  become: yes

- name: Wait for Jenkins to be ready
  uri:
    url: "{{ jenkins_base_url }}/login"
    method: GET
    timeout: 30
  register: jenkins_ready_check
  retries: 10
  delay: 15
  until: jenkins_ready_check.status == 200
  delegate_to: "{{ groups['jenkins'][0] }}"

# Cleanup
- name: Clean up temporary files on Keycloak server
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/configure_keycloak.py
    - /tmp/keycloak-config.json
  delegate_to: "{{ groups['keycloak'][0] }}"

- name: Clean up local temporary directory
  file:
    path: "{{ temp_dir.path }}"
    state: absent
  delegate_to: localhost
  run_once: true

# Final verification
- name: Verify OIDC endpoints are accessible
  uri:
    url: "{{ keycloak_admin_url }}/realms/{{ sso_realm_name }}/.well-known/openid_configuration"
    method: GET
  register: oidc_config_check

- name: Display SSO setup completion
  debug:
    msg: |
      âœ… Jenkins-Keycloak SSO Setup Complete!

      ğŸ“‹ Configuration Summary:
      ğŸ›ï¸  Keycloak Realm: {{ sso_realm_name }}
      ğŸ‘¤ Client ID: {{ jenkins_client_id }}
      ğŸ”— OIDC Well-known URL: {{ keycloak_admin_url }}/realms/{{ sso_realm_name }}/.well-known/openid_configuration

      ğŸŒ Access Information:
      â€¢ Jenkins (Direct): {{ jenkins_base_url }}
      â€¢ Jenkins (Proxy): {{ jenkins_proxy_url }}
      â€¢ Keycloak Admin: {{ keycloak_admin_url }}/admin/

      ğŸ‘¥ Test Users (if created):
      {% if sso_create_test_users %}
      {% for user in sso_test_users %}
      â€¢ {{ user.username }} ({{ user.groups | join(', ') }})
      {% endfor %}
      {% endif %}

      ğŸ”§ Next Steps:
      1. Access Jenkins and verify SSO login works
      2. Configure Jenkins authorization strategy if needed
      3. Set up role-based access control using Keycloak groups
      4. Test user permissions and access
